{% extends "base.html" %}

{% block title %}{{ config.WEBSITE_NAME }} - Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-slate-800">System Dashboard</h2>
        <div class="text-sm text-slate-500">
            Last updated: <span id="last-updated">Just now</span>
        </div>
    </div>

    <!-- Summary Numbers -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-brand-500">
            <div class="text-sm text-slate-500 uppercase font-semibold">Total Clients</div>
            <div class="text-3xl font-bold text-slate-800 mt-1">{{ total_ips }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500">
            <div class="text-sm text-slate-500 uppercase font-semibold">Active Clients</div>
            <div class="text-3xl font-bold text-green-600 mt-1">{{ active_ips }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-red-500">
            <div class="text-sm text-slate-500 uppercase font-semibold">Expired Clients</div>
            <div class="text-3xl font-bold text-red-600 mt-1">{{ expired_ips }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-teal-500">
            <div class="text-sm text-slate-500 uppercase font-semibold">Total Domains</div>
            <div class="text-3xl font-bold text-teal-600 mt-1">{{ total_domains }}</div>
        </div>
    </div>


    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- CPU Usage -->
        <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-100 flex flex-col items-center">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">CPU Usage</h3>
            <div class="relative w-40 h-40">
                <canvas id="cpuChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <span class="text-2xl font-bold text-slate-800" id="cpuPercentage">0%</span>
                </div>
            </div>
        </div>

        <!-- RAM Usage -->
        <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-100 flex flex-col items-center">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">RAM Usage</h3>
            <div class="relative w-40 h-40">
                <canvas id="ramChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <span class="text-2xl font-bold text-slate-800" id="ramPercentage">0%</span>
                </div>
            </div>
        </div>

        <!-- Server Status -->
        <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-100">
            <h3 class="text-lg font-semibold text-slate-700 mb-4 border-b pb-2">Server Status</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-slate-500">Squid Service</span>
                    <span
                        class="px-2 py-1 rounded-full text-xs font-semibold {{ 'bg-green-100 text-green-800' if squid_status == 'Running' else 'bg-red-100 text-red-800' }}">
                        {{ squid_status }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-500">Uptime</span>
                    <span class="font-medium text-slate-800">{{ server_uptime }}</span>
                </div>
                {% if squid_status == "Running" and squid_started_time %}
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Started</span>
                    <span class="text-slate-700">{{ squid_started_time }}</span>
                </div>
                {% endif %}
                {% if squid_reload_time %}
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Reloaded</span>
                    <span class="text-slate-700">{{ squid_reload_time }}</span>
                </div>
                {% endif %}
                <div class="pt-4 mt-2 border-t flex justify-between items-center">
                    <span class="text-slate-500">Bandwidth</span>
                    <span class="font-bold text-brand-600" id="bandwidth">0 Mbps</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bandwidth History Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-slate-700">Bandwidth Usage (Last 24 Hours)</h3>
            <div class="flex gap-2">
                <button onclick="loadBandwidthChart(6)"
                    class="px-3 py-1 text-xs rounded-md bg-slate-100 hover:bg-slate-200 text-slate-700">6h</button>
                <button onclick="loadBandwidthChart(12)"
                    class="px-3 py-1 text-xs rounded-md bg-slate-100 hover:bg-slate-200 text-slate-700">12h</button>
                <button onclick="loadBandwidthChart(24)"
                    class="px-3 py-1 text-xs rounded-md bg-brand-500 text-white">24h</button>
            </div>
        </div>
        <div class="relative" style="height: 300px;">
            <canvas id="bandwidthChart"></canvas>
        </div>
    </div>


    <!-- Clients Table Section -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="text-lg font-semibold text-slate-800">Expiring Clients</h3>
            <span class="text-xs text-slate-500">Showing clients expiring within 14 days and expired</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200" id="clients-table">
                <thead class="bg-slate-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">IP
                            Address</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date
                            Added</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Expiration</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Days Remaining
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {% for client in client_data %}
                    <tr class="hover:bg-slate-50 transition-colors {{ 'bg-red-50' if client.expired else '' }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">#{{ client.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                            {{ client.ip_address }}
                            {% if client.dns_hostname %}
                            <div class="text-xs text-slate-500 font-normal mt-0.5">{{ client.dns_hostname }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ client.date_added }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ client.expiration_date }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if client.days_remaining < 0 %} <span
                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                Expired ({{ client.days_remaining|abs }} days ago)</span>
                                {% elif client.days_remaining <= 7 %} <span
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                    {{ client.days_remaining }} days</span>
                                    {% else %}
                                    <span
                                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{{
                                        client.days_remaining }} days</span>
                                    {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="px-6 py-3 flex items-center justify-between border-t border-slate-200 bg-slate-50">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-slate-700">
                        Showing <span class="font-medium" id="page-start">1</span> to <span class="font-medium"
                            id="page-end">10</span> of <span class="font-medium">{{ client_data|length }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination"
                        id="pagination">
                        <!-- Pagination Buttons Generated by JS -->
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart.js Setup
    const getUsageColor = (usage) => usage > 90 ? '#ef4444' : usage > 80 ? '#f59e0b' : '#3b82f6';

    const createChart = (chartId, chartInstance, percent, label) => {
        const ctx = document.getElementById(chartId).getContext('2d');
        const color = getUsageColor(percent);
        if (!chartInstance) {
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [percent, 100 - percent],
                        backgroundColor: [color, '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    cutout: '75%',
                    animation: { animateScale: true }
                }
            });
        } else {
            chartInstance.data.datasets[0].data = [percent, 100 - percent];
            chartInstance.data.datasets[0].backgroundColor = [color, '#f1f5f9'];
            chartInstance.update();
            return chartInstance;
        }
    };

    let cpuChart, ramChart;
    const refreshStats = () => {
        const now = new Date();
        document.getElementById('last-updated').innerText = now.toLocaleTimeString();

        fetch('/api/system_stats')
            .then(res => res.json())
            .then(data => {
                cpuChart = createChart('cpuChart', cpuChart, data.cpu_percent, 'CPU');
                ramChart = createChart('ramChart', ramChart, data.ram_percent, 'RAM');
                document.getElementById('cpuPercentage').innerText = `${data.cpu_percent}%`;
                document.getElementById('ramPercentage').innerText = `${data.ram_percent}%`;

                // Color update for percentages texts
                document.getElementById('cpuPercentage').className = `text-2xl font-bold ${data.cpu_percent > 90 ? 'text-red-500' : 'text-slate-800'}`;

                document.getElementById('bandwidth').innerText = `${data.bandwidth}`;
            })
            .catch(err => console.error('Error fetching stats:', err));
    };

    refreshStats();
    setInterval(refreshStats, 3000);

    // Bandwidth Chart Setup
    let bandwidthChart = null;
    let currentHours = 24;

    const loadBandwidthChart = (hours = 24) => {
        currentHours = hours;

        // Update button states
        document.querySelectorAll('[onclick^="loadBandwidthChart"]').forEach(btn => {
            const btnHours = parseInt(btn.getAttribute('onclick').match(/\d+/)[0]);
            if (btnHours === hours) {
                btn.className = 'px-3 py-1 text-xs rounded-md bg-brand-500 text-white';
            } else {
                btn.className = 'px-3 py-1 text-xs rounded-md bg-slate-100 hover:bg-slate-200 text-slate-700';
            }
        });

        fetch(`/api/bandwidth_history?hours=${hours}`)
            .then(res => res.json())
            .then(data => {
                const ctx = document.getElementById('bandwidthChart').getContext('2d');

                if (bandwidthChart) {
                    bandwidthChart.destroy();
                }

                bandwidthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Bandwidth (Mbps)',
                            data: data.data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} Mbps`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Mbps'
                                },
                                ticks: {
                                    callback: (value) => value.toFixed(1)
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => console.error('Error loading bandwidth chart:', err));
    };

    // Load chart on page load
    loadBandwidthChart(24);

    // Refresh chart every 5 minutes
    setInterval(() => loadBandwidthChart(currentHours), 300000);

    // Pagination Logic (Compatible with Tailwind)
    document.addEventListener('DOMContentLoaded', () => {
        const table = document.getElementById('clients-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const rowsPerPage = 10;
        const pagination = document.getElementById('pagination');
        let currentPage = 1;

        const updatePaginationInfo = (start, end) => {
            const total = rows.length;
            document.getElementById('page-start').innerText = total === 0 ? 0 : start + 1;
            document.getElementById('page-end').innerText = Math.min(end, total);
        };

        const displayRows = () => {
            const start = (currentPage - 1) * rowsPerPage;
            const end = currentPage * rowsPerPage;

            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? '' : 'none';
            });
            updatePaginationInfo(start, end);
        };

        const createPageButton = (page, isActive, isNav = false, text = null) => {
            const btn = document.createElement('button');
            btn.href = '#';

            let classes = "relative inline-flex items-center px-4 py-2 border text-sm font-medium ";
            if (isActive) {
                classes += "z-10 bg-brand-50 border-brand-500 text-brand-600";
            } else {
                classes += "bg-white border-slate-300 text-slate-500 hover:bg-slate-50";
            }

            if (isNav) {
                // First/Last rounding
                // Simplified, assuming middle buttons
            }

            btn.className = classes;
            btn.innerText = text || page;
            btn.onclick = (e) => {
                e.preventDefault();
                currentPage = page;
                setupPagination();
                displayRows();
            };
            return btn;
        };

        const setupPagination = () => {
            pagination.innerHTML = '';
            const totalPages = Math.ceil(rows.length / rowsPerPage);
            if (totalPages <= 1) return;

            // Previous
            const prevBtn = document.createElement('button');
            prevBtn.className = "relative inline-flex items-center px-2 py-2 rounded-l-md border border-slate-300 bg-white text-sm font-medium text-slate-500 hover:bg-slate-50";
            prevBtn.innerHTML = '<span class="sr-only">Previous</span><i class="fas fa-chevron-left h-5 w-5 p-1"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; setupPagination(); displayRows(); } };
            pagination.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
                pagination.appendChild(createPageButton(i, i === currentPage));
            }

            // Next
            const nextBtn = document.createElement('button');
            nextBtn.className = "relative inline-flex items-center px-2 py-2 rounded-r-md border border-slate-300 bg-white text-sm font-medium text-slate-500 hover:bg-slate-50";
            nextBtn.innerHTML = '<span class="sr-only">Next</span><i class="fas fa-chevron-right h-5 w-5 p-1"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; setupPagination(); displayRows(); } };
            pagination.appendChild(nextBtn);
        };

        const sortByDaysRemaining = (order = 'asc') => {
            // ... Reuse logic, simpler for brevity ...
            rows.sort((a, b) => {
                const aText = a.children[4].innerText.trim();
                const bText = b.children[4].innerText.trim();
                const aValue = aText.includes('Expired') ? -1 : parseInt(aText);
                const bValue = bText.includes('Expired') ? -1 : parseInt(bText);
                return order === 'asc' ? aValue - bValue : bValue - aValue;
            });
            rows.forEach(row => tbody.appendChild(row));
            displayRows();
        };

        displayRows();
        setupPagination();

        // Sort Event
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const order = btn.getAttribute('data-order') === 'asc' ? 'desc' : 'asc';
                btn.setAttribute('data-order', order);
                sortByDaysRemaining(order);
            });
        });
    });
</script>
{% endblock %}